---
import BaseHead from '../../../components/BaseHead.astro';
import Header from '../../../components/Header.astro';
import Footer from '../../../components/Footer.astro';
import { SITE_TITLE } from '../../../consts';
import { getCollection, type CollectionEntry } from 'astro:content';
import FormattedDate from '../../../components/FormattedDate.astro';

export async function getStaticPaths() {
  const breakdownsUnprocessed = (await getCollection('breakdowns')).sort(
    (a: CollectionEntry<'breakdowns'>, b: CollectionEntry<'breakdowns'>) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
  );

  const breakdowns = await Promise.all(
    breakdownsUnprocessed.map(async (breakdown) => {
      const wordCount = (breakdown.body || '').split(/\s+/).length;
      const readingTime = `${Math.max(1, Math.ceil(wordCount / 200))} min read`;
      return {
        ...breakdown,
        readingTime,
      };
    })
  );

  const BREAKDOWNS_PER_PAGE = 10;
  const totalPages = Math.ceil(breakdowns.length / BREAKDOWNS_PER_PAGE);

  return Array.from({ length: totalPages - 1 }, (_, i) => {
    const page = i + 2; // Start from page 2
    const start = page * BREAKDOWNS_PER_PAGE - BREAKDOWNS_PER_PAGE;
    const end = start + BREAKDOWNS_PER_PAGE;
    const paginatedBreakdowns = breakdowns.slice(start, end);

    return {
      params: { page: page.toString() },
      props: { 
        breakdowns: paginatedBreakdowns, 
        page, 
        totalPages,
      },
    };
  });
}

const { breakdowns, page, totalPages } = Astro.props;
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead title={`1Day Breakdowns - Page ${page} | ${SITE_TITLE}`} description="Quick technical breakdowns and analyses of recent 1Day vulnerabilities and exploits." />
  </head>
  <body>
    <Header />
    <main class="container">
      <section class="intro-section animate-fade-in">
        <h1 class="page-title">1Day Breakdowns - Page {page}</h1>
        <p class="page-subtitle">Rapid technical analysis of recent vulnerabilities.</p>
      </section>

      <div class="posts-list animate-fade-in" style="animation-delay: 0.1s;">
        {breakdowns.length === 0 ? (
          <div class="no-posts">
            No breakdowns found.
          </div>
        ) : (
          breakdowns.map((breakdown) => (
            <article class="post-item">
              <div class="post-meta-top">
                <FormattedDate date={breakdown.data.pubDate} />
              </div>
              <a href={`/breakdowns/${breakdown.id}/`} class="post-link">
                <h2 class="post-title">{breakdown.data.title}</h2>
              </a>
              <p class="post-summary">{breakdown.data.summary || breakdown.data.description}</p>
              <div class="post-meta-bottom">
                {breakdown.data.author && <span class="author-name">{breakdown.data.author}</span>}
                <span class="reading-time">{breakdown.readingTime}</span>
                {breakdown.data.tags && breakdown.data.tags.length > 0 && (
                  <div class="tags-list">
                    {breakdown.data.tags.map(tag => (
                      <span class="tag">#{tag}</span>
                    ))}
                  </div>
                )}
              </div>
            </article>
          ))
        )}
      </div>

      {totalPages > 1 && (
        <nav class="pagination">
          {page > 1 && <a href={page === 2 ? "/breakdowns/" : `/breakdowns/page/${page - 1}/`} class="pagination-link">← Previous</a>}
          <a href="/breakdowns/" class={`pagination-link${page === 1 ? ' active' : ''}`}>1</a>
          {totalPages >= 2 && <a href="/breakdowns/page/2/" class={`pagination-link${page === 2 ? ' active' : ''}`}>2</a>}
          {totalPages >= 3 && <a href="/breakdowns/page/3/" class={`pagination-link${page === 3 ? ' active' : ''}`}>3</a>}
          {page < totalPages && <a href={`/breakdowns/page/${page + 1}/`} class="pagination-link">Next →</a>}
        </nav>
      )}
    </main>
    <Footer />
  </body>
</html>