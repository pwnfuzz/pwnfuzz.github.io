---
import BaseHead from '../../components/BaseHead.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { SITE_TITLE } from '../../consts';
import { getCollection, type CollectionEntry } from 'astro:content';
import FormattedDate from '../../components/FormattedDate.astro';

export async function getStaticPaths() {
  const postsUnprocessed = (await getCollection('blog')).filter(
    post => post.data.summary || post.data.description
  );
  const POSTS_PER_PAGE = 10;
  const totalPages = Math.ceil(postsUnprocessed.length / POSTS_PER_PAGE);
  return Array.from({ length: totalPages }, (_, i) => ({ params: { page: String(i + 1) } }));
}

const postsUnprocessed = (await getCollection('blog')).filter(
  post => post.data.summary || post.data.description
).sort(
  (a: CollectionEntry<'blog'>, b: CollectionEntry<'blog'>) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);

const posts = await Promise.all(
  postsUnprocessed.map(async (post) => {
    const wordCount = (post.body || '').split(/\s+/).length;
    const readingTime = `${Math.max(1, Math.ceil(wordCount / 200))} min read`;
    return {
      ...post,
      readingTime,
    };
  })
);

const POSTS_PER_PAGE = 10;
const page = Number(Astro.params.page);
const totalPages = Math.ceil(posts.length / POSTS_PER_PAGE);
const paginatedPosts = posts.slice((page - 1) * POSTS_PER_PAGE, page * POSTS_PER_PAGE);
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead title={`Blog - Page ${page} | ${SITE_TITLE}`} description="Technical writeups and security research." />
  </head>
  <body>
    <Header />
    <main class="container">
      <section class="intro-section animate-fade-in">
        <h1 class="page-title">Articles - Page {page}</h1>
        <p class="page-subtitle">Technical deep dives into security, engineering, and fuzzing.</p>
      </section>

      <div class="posts-list animate-fade-in" style="animation-delay: 0.1s;">
        {paginatedPosts.length === 0 ? (
          <div class="no-posts">
            No blog posts found.
          </div>
        ) : (
          paginatedPosts.map((post) => (
            <article class="post-item">
              <div class="post-meta-top">
                <FormattedDate date={post.data.pubDate} />
              </div>
              <a href={`/posts/${post.id}/`} class="post-link">
                <h2 class="post-title">{post.data.title}</h2>
              </a>
              <p class="post-summary">{post.data.summary || post.data.description}</p>
              <div class="post-meta-bottom">
                {post.data.author && <span class="author-name">{post.data.author}</span>}
                <span class="reading-time">{post.readingTime}</span>
                {post.data.tags && post.data.tags.length > 0 && (
                  <div class="tags-list">
                    {post.data.tags.map(tag => (
                      <span class="tag">#{tag}</span>
                    ))}
                  </div>
                )}
              </div>
            </article>
          ))
        )}
      </div>

      {totalPages > 1 && (
        <nav class="pagination">
          {page > 1 && <a href={page === 2 ? "/" : `/page/${page - 1}/`} class="pagination-link">← Previous</a>}
          <a href="/" class={`pagination-link${page === 1 ? ' active' : ''}`}>1</a>
          {totalPages >= 2 && <a href="/page/2/" class={`pagination-link${page === 2 ? ' active' : ''}`}>2</a>}
          {totalPages >= 3 && <a href="/page/3/" class={`pagination-link${page === 3 ? ' active' : ''}`}>3</a>}
          {page < totalPages && <a href={`/page/${page + 1}/`} class="pagination-link">Next →</a>}
        </nav>
      )}
    </main>
    <Footer />
  </body>
</html>