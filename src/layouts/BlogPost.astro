---
import type { CollectionEntry } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import FormattedDate from '../components/FormattedDate.astro';
import { Image } from 'astro:assets';

type Props = CollectionEntry<'blog'>['data'];

const { title, description, pubDate, updatedDate, heroImage } = Astro.props;
---

<html lang="en">
  <head>
    <BaseHead title={title} description={description} />
  </head>

  <body>
    <div class="reading-progress" id="readingProgress"></div>
    <Header />
    <main class="container">
      <article class="post-article">
        <div class="post-header">
          <div class="post-meta">
            <FormattedDate date={pubDate} />
            {updatedDate && (
              <span class="updated-date">
                (Updated: <FormattedDate date={updatedDate} />)
              </span>
            )}
          </div>
          <h1 class="post-title">{title}</h1>
          {Astro.props.author && (
            <div class="author-badge">
              <img src={`/img/team/${Astro.props.author.toLowerCase()}.jpg`} alt={Astro.props.author} class="author-avatar" />
              <span class="author-name">{Astro.props.author}</span>
            </div>
          )}
        </div>

        {heroImage && (
          <div class="hero-image-container">
            <Image width={1200} height={600} src={heroImage} alt="" class="hero-image" />
          </div>
        )}

        <div class="content-wrapper">
          <div class="inline-toc">
            <details>
              <summary>Table of Contents</summary>
              <nav class="toc-nav">
                <ul class="toc-list"></ul>
              </nav>
            </details>
          </div>

          <div class="prose">
            <slot />
          </div>
        </div>

        <div class="post-footer">
          <a href="/posts/" class="back-link">&larr; Back to all posts</a>
        </div>
      </article>
    </main>
    <Footer />

    <script>
      // TOC Generation
      const tocList = document.querySelector('.toc-list');
      const content = document.querySelector('.prose');
      
      if (tocList && content) {
        const headings = Array.from(content.querySelectorAll('h2, h3'));
        
        if (headings.length > 0) {
          headings.forEach(h => {
            if (!h.id) {
              h.id = h.textContent?.toLowerCase().replace(/[^a-z0-9]+/g, '-') || '';
            }
            
            const li = document.createElement('li');
            li.className = `toc-item-${h.tagName.toLowerCase()}`;
            
            const a = document.createElement('a');
            a.href = `#${h.id}`;
            a.textContent = h.textContent;
            a.className = 'toc-link';
            
            li.appendChild(a);
            tocList.appendChild(li);
          });
        } else {
          const tocContainer = document.querySelector('.inline-toc');
          if (tocContainer) {
            (tocContainer as HTMLElement).style.display = 'none';
          }
        }
      }
    </script>

    <script>
      // Reading Progress Indicator
      const progressBar = document.getElementById('readingProgress');
      
      window.addEventListener('scroll', () => {
        const windowHeight = window.innerHeight;
        const documentHeight = document.documentElement.scrollHeight;
        const scrollTop = window.scrollY;
        const scrollPercent = (scrollTop / (documentHeight - windowHeight)) * 100;
        
        if (progressBar) {
          progressBar.style.width = `${Math.min(scrollPercent, 100)}%`;
        }
      });
    </script>

    <style>
      .reading-progress {
        position: fixed;
        top: 0;
        left: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
        z-index: 1001;
        transition: width 0.1s ease;
        width: 0;
      }

      .post-article {
        padding: 4rem 0;
      }

      .post-header {
        text-align: center;
        max-width: 1000px;
        margin: 0 auto 3rem auto;
      }

      .post-meta {
        color: var(--fg-muted);
        font-family: var(--font-mono);
        font-size: 0.9rem;
        margin-bottom: 1rem;
      }

      .updated-date {
        margin-left: 0.5rem;
        color: var(--fg-secondary);
      }

      .post-title {
        font-size: 3.5rem;
        margin-bottom: 1.5rem;
        color: var(--fg-primary);
        line-height: 1.1;
        letter-spacing: -0.02em;
      }

      .author-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.8rem;
        padding: 0.5rem 1rem;
      }

      .author-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 1px solid var(--border-subtle);
      }

      .author-name {
        font-weight: 500;
        color: var(--fg-primary);
        font-size: 0.95rem;
      }

      .hero-image-container {
        margin: 0 auto 4rem auto;
        max-width: 1400px;
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid var(--border-subtle);
        box-shadow: var(--shadow-lg);
      }

      .hero-image {
        width: 100%;
        height: auto;
        display: block;
      }

      .content-wrapper {
        max-width: 1000px; /* Wide single column */
        margin: 0 auto;
      }

      /* Inline TOC */
      .inline-toc {
        margin-bottom: 3rem;
        border: 1px solid var(--border-subtle);
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.4); /* More transparent */
        backdrop-filter: blur(8px);
      }

      .inline-toc details {
        padding: 1rem;
      }

      .inline-toc summary {
        cursor: pointer;
        font-weight: 600;
        color: var(--fg-primary);
        list-style: none;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .inline-toc summary::before {
        content: 'â–º';
        font-size: 0.8em;
        transition: transform 0.2s;
      }

      .inline-toc details[open] summary::before {
        transform: rotate(90deg);
      }

      .toc-nav {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border-subtle);
      }

      .toc-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .toc-link {
        color: var(--fg-secondary);
        font-size: 0.95rem;
        text-decoration: none;
        transition: color 0.2s ease;
      }

      .toc-link:hover {
        color: var(--accent-link);
        text-decoration: underline;
      }

      .toc-item-h3 {
        padding-left: 1.5rem;
        font-size: 0.9rem;
      }

      .prose {
        font-size: 1rem; /* Reduced to match listing (16px) */
        line-height: 1.75;
        color: var(--fg-primary);
        min-width: 0;
        max-width: 1000px; /* Limit prose width for readability within the wide container */
      }

      /* Prose Specific Overrides */
      .prose h2 {
        font-size: 2rem;
        margin-top: 3.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--border-subtle);
        color: var(--fg-primary);
      }

      .prose h3 {
        font-size: 1.5rem;
        margin-top: 2.5rem;
        color: var(--fg-primary);
      }

      .prose ul, .prose ol {
        margin-bottom: 1.5rem;
        padding-left: 1.5rem;
        color: var(--fg-secondary);
      }

      .prose li {
        margin-bottom: 0.5rem;
      }

      .prose strong {
        color: var(--fg-primary);
        font-weight: 600;
      }

      .post-footer {
        margin-top: 5rem;
        text-align: center;
        padding-top: 3rem;
        border-top: 1px solid var(--border-subtle);
      }

      .back-link {
        display: inline-block;
        padding: 0.8rem 1.5rem;
        border: 1px solid var(--border-subtle);
        border-radius: 8px;
        color: var(--fg-secondary);
        font-weight: 500;
        font-size: 1rem;
        transition: all 0.2s ease;
        background: rgba(255, 255, 255, 0.5); /* Glassy */
        backdrop-filter: blur(4px);
      }

      .back-link:hover {
        border-color: var(--fg-muted);
        color: var(--fg-primary);
        transform: translateY(-2px);
      }

      @media (max-width: 768px) {
        .post-title {
          font-size: 2.5rem;
        }
        
        .prose {
          font-size: 1.1rem;
        }
      }
    </style>
  </body>
</html>
