---
import type { CollectionEntry } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import FormattedDate from '../components/FormattedDate.astro';
import { Image } from 'astro:assets';

type Props = CollectionEntry<'blog'>['data'];

const { title, description, pubDate, updatedDate, heroImage } = Astro.props;
---

<html lang="en">
  <head>
    <BaseHead title={title} description={description} />
  </head>

  <body>
    <div class="reading-progress" id="readingProgress"></div>
    <Header />
    <main>
      <article class="post-article">
        <div class="post-header">
          <div class="post-meta">
            <FormattedDate date={pubDate} />
            {updatedDate && (
              <span class="updated-date">
                (Updated: <FormattedDate date={updatedDate} />)
              </span>
            )}
          </div>
          <h1 class="post-title">{title}</h1>
          {Astro.props.author && (
            <div class="author-badge">
              <img src={`/img/team/${Astro.props.author.toLowerCase()}.jpg`} alt={Astro.props.author} class="author-avatar" />
              <span class="author-name">{Astro.props.author}</span>
            </div>
          )}
        </div>

        {heroImage && (
          <div class="hero-image-container">
            <Image width={1200} height={600} src={heroImage} alt="" class="hero-image" />
          </div>
        )}

        <div class="content-grid">
          <aside class="sidebar-left">
            <div class="sticky-toc desktop-only">
              <h3 class="toc-title">Table of Contents</h3>
              <nav class="toc-nav">
                <ul class="toc-list-desktop"></ul>
              </nav>
            </div>
          </aside>

          <div class="prose-container">
            <!-- Mobile/Inline TOC (Hidden on Desktop) -->
            <div class="inline-toc mobile-only">
              <details>
                <summary>Table of Contents</summary>
                <nav class="toc-nav">
                  <ul class="toc-list-mobile"></ul>
                </nav>
              </details>
            </div>

            <div class="prose">
              <slot />
            </div>
          </div>

          <aside class="sidebar-right">
            <div class="sticky-share desktop-only">
              <div class="share-label">Liked this post? Share it!</div>
              <div class="share-buttons">
                <a href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(title)}&url=${encodeURIComponent(Astro.url)}`} target="_blank" rel="noopener noreferrer" class="share-btn" aria-label="Share on Twitter">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 4s-.7 2.1-2 3.4c1.6 10-9.4 17.3-18 11.6 2.2.1 4.4-.6 6-2C3 15.5.5 9.6 3 5c2.2 2.6 5.6 4.1 9 4-.9-4.2 4-6.6 7-3.8 1.1 0 3-1.2 3-1.2z"/></svg>
                  <span>Twitter</span>
                </a>
                <a href={`https://www.linkedin.com/shareArticle?mini=true&url=${encodeURIComponent(Astro.url)}&title=${encodeURIComponent(title)}`} target="_blank" rel="noopener noreferrer" class="share-btn" aria-label="Share on LinkedIn">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg>
                  <span>LinkedIn</span>
                </a>
                <button id="copyLinkBtn" class="share-btn" aria-label="Copy Link">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                  <span>Copy Link</span>
                  <div id="shareTooltip" class="share-tooltip">Link copied!</div>
                </button>
              </div>
            </div>
          </aside>
        </div>

        <div class="post-footer">
          <a href="/posts/" class="back-link">&larr; Back to all posts</a>
        </div>
      </article>
    </main>

    <!-- Scroll to Top Button -->
    <button id="scrollToTopBtn" class="scroll-to-top" aria-label="Scroll to top">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="18 15 12 9 6 15"></polyline>
      </svg>
    </button>

    <Footer />

    <script>
      // TOC Generation
      const content = document.querySelector('.prose');
      const mobileTocList = document.querySelector('.toc-list-mobile');
      const desktopTocList = document.querySelector('.toc-list-desktop');
      
      if (content) {
        const headings = Array.from(content.querySelectorAll('h1, h2, h3'));
        
        if (headings.length > 0) {
          headings.forEach(h => {
            if (!h.id) {
              h.id = h.textContent?.toLowerCase().replace(/[^a-z0-9]+/g, '-') || '';
            }
            
            // Create link data
            const linkText = h.textContent;
            const linkHref = `#${h.id}`;
            const itemClass = `toc-item-${h.tagName.toLowerCase()}`;

            // Populate Mobile TOC
            if (mobileTocList) {
              const li = document.createElement('li');
              li.className = itemClass;
              const a = document.createElement('a');
              a.href = linkHref;
              a.textContent = linkText;
              a.className = 'toc-link';
              li.appendChild(a);
              mobileTocList.appendChild(li);
            }

            // Populate Desktop TOC
            if (desktopTocList) {
              const li = document.createElement('li');
              li.className = itemClass;
              const a = document.createElement('a');
              a.href = linkHref;
              a.textContent = linkText;
              a.className = 'toc-link';
              li.appendChild(a);
              desktopTocList.appendChild(li);
            }
          });

          // Highlight active section in Desktop TOC
          const observerOptions = {
            root: null,
            rootMargin: '-100px 0px -66%',
            threshold: 0
          };

          const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
              if (entry.isIntersecting) {
                const id = entry.target.id;
                const activeLink = desktopTocList?.querySelector(`a[href="#${id}"]`);
                
                if (activeLink) {
                  desktopTocList?.querySelectorAll('.toc-link').forEach(link => link.classList.remove('active'));
                  activeLink.classList.add('active');
                }
              }
            });
          }, observerOptions);

          headings.forEach(h => observer.observe(h));

        } else {
          // Hide TOC containers if no headings
          document.querySelectorAll('.inline-toc, .sticky-toc').forEach(el => {
            (el as HTMLElement).style.display = 'none';
          });
        }
      }
    </script>

    <script>
      // Reading Progress Indicator
      const progressBar = document.getElementById('readingProgress');
      
      window.addEventListener('scroll', () => {
        const windowHeight = window.innerHeight;
        const documentHeight = document.documentElement.scrollHeight;
        const scrollTop = window.scrollY;
        const scrollPercent = (scrollTop / (documentHeight - windowHeight)) * 100;
        
        if (progressBar) {
          progressBar.style.width = `${Math.min(scrollPercent, 100)}%`;
        }
      });
    </script>

    <script>
      // Share Button Logic
      const copyLinkBtn = document.getElementById('copyLinkBtn');
      const shareTooltip = document.getElementById('shareTooltip');

      if (copyLinkBtn && shareTooltip) {
        copyLinkBtn.addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(window.location.href);
            
            // Show tooltip
            shareTooltip.classList.add('visible');
            
            // Hide after 2 seconds
            setTimeout(() => {
              shareTooltip.classList.remove('visible');
            }, 2000);
          } catch (err) {
            console.error('Failed to copy link:', err);
          }
        });
      }
    </script>

    <script>
      // Scroll to Top Button
      const scrollToTopBtn = document.getElementById('scrollToTopBtn');
      
      window.addEventListener('scroll', () => {
        if (window.scrollY > 300) {
          scrollToTopBtn?.classList.add('visible');
        } else {
          scrollToTopBtn?.classList.remove('visible');
        }
      });

      scrollToTopBtn?.addEventListener('click', () => {
        window.scrollTo({
          top: 0,
          behavior: 'smooth'
        });
      });
    </script>

    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "BlogPosting",
      "headline": title,
      "image": heroImage ? new URL(heroImage, Astro.site) : undefined,
      "datePublished": pubDate.toISOString(),
      "dateModified": updatedDate ? updatedDate.toISOString() : pubDate.toISOString(),
      "author": {
        "@type": "Person",
        "name": Astro.props.author || "PwnFuzz Labs"
      },
      "description": description
    })} />

    <style>
      .reading-progress {
        position: fixed;
        top: 0;
        left: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
        z-index: 1001;
        transition: width 0.1s ease;
        width: 0;
      }

      /* Scroll to Top Button */
      .scroll-to-top {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        color: var(--fg-secondary);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transform: translateY(20px);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: var(--shadow-md);
        z-index: 999;
      }

      .scroll-to-top.visible {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      .scroll-to-top:hover {
        background: var(--accent-primary);
        color: white;
        border-color: var(--accent-primary);
        transform: translateY(-4px);
        box-shadow: 0 8px 16px rgba(255, 158, 100, 0.3);
      }

      .scroll-to-top svg {
        width: 20px;
        height: 20px;
      }

      .post-article {
        padding: 4rem 0;
      }

      .post-header {
        text-align: center;
        max-width: 800px; /* Keep header centered and focused */
        margin: 0 auto 3rem auto;
      }

      .post-meta {
        color: var(--fg-muted);
        font-family: var(--font-mono);
        font-size: 0.9rem;
        margin-bottom: 1rem;
      }

      .updated-date {
        margin-left: 0.5rem;
        color: var(--fg-secondary);
      }

      .post-title {
        font-size: 3.5rem;
        margin-bottom: 1.5rem;
        color: var(--fg-primary);
        line-height: 1.1;
        letter-spacing: -0.02em;
      }

      .author-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.8rem;
        padding: 0.5rem 1rem;
      }

      .author-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 1px solid var(--border-subtle);
      }

      .author-name {
        font-weight: 500;
        color: var(--fg-primary);
        font-size: 0.95rem;
      }

      .hero-image-container {
        margin: 0 auto 4rem auto;
        max-width: 1200px;
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid var(--border-subtle);
        box-shadow: var(--shadow-lg);
      }

      .hero-image {
        width: 100%;
        height: auto;
        display: block;
      }

      /* Layout Grid - Fixed Widths for Proper Alignment */
      .content-grid {
        display: grid;
        grid-template-columns: 280px 900px 280px; /* Increased center from 800px to 900px */
        gap: 3rem;
        max-width: 1560px; /* 280 + 900 + 280 + gaps */
        margin: 0 auto;
        align-items: start;
        padding: 0 2rem;
      }

      .sidebar-left {
        /* TOC container */
      }

      .prose-container {
        width: 100%;
      }

      /* TOC - Left Sidebar (Sticky) */
      .sticky-toc {
        position: sticky;
        top: 100px;
        max-height: calc(100vh - 120px);
        overflow-y: auto;
      }

      .toc-title {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--fg-muted);
        margin-bottom: 1.2rem;
        font-weight: 700;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .toc-list-desktop {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
      }

      .toc-link {
        color: var(--fg-secondary);
        font-size: 0.9rem;
        text-decoration: none;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: block;
        line-height: 1.4;
        border-left: 2px solid transparent;
        padding-left: 0.8rem;
        padding-right: 0.5rem;
        margin-left: 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        border-radius: 0 4px 4px 0;
      }

      .toc-link:hover {
        color: var(--accent-link);
        border-left-color: var(--accent-primary);
        background: rgba(255, 158, 100, 0.08);
        padding-left: 1rem;
      }

      .toc-link.active {
        color: var(--accent-primary);
        border-left-color: var(--accent-primary);
        font-weight: 600;
        background: rgba(255, 158, 100, 0.12);
      }

      .toc-item-h3 .toc-link {
        padding-left: 1.5rem;
        font-size: 0.85rem;
        color: var(--fg-muted);
      }

      /* Share Section - Right Sidebar (Sticky) */
      .sticky-share {
        position: sticky;
        top: 100px;
        padding: 1.5rem;
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: 12px;
        box-shadow: var(--shadow-sm);
      }

      .share-label {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--fg-primary);
        margin-bottom: 1rem;
        text-align: center;
      }

      .share-buttons {
        display: flex;
        flex-direction: row;
        gap: 0.8rem;
        justify-content: center;
      }

      .share-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        padding: 0;
        background: transparent;
        border: 1px solid var(--border-subtle);
        border-radius: 50%;
        color: var(--fg-secondary);
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        text-decoration: none;
        position: relative;
      }

      .share-btn span {
        display: none; /* Hide text, icon only */
      }

      .share-btn:hover {
        background: var(--bg-card-hover);
        border-color: var(--accent-primary);
        color: var(--accent-primary);
        transform: scale(1.15) translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 158, 100, 0.3), 0 0 20px rgba(255, 158, 100, 0.15);
      }

      .share-btn svg {
        width: 18px;
        height: 18px;
      }

      .share-tooltip {
        position: absolute;
        bottom: -35px;
        left: 50%;
        transform: translateX(-50%);
        opacity: 0;
        background: var(--fg-primary);
        color: var(--bg-main);
        padding: 0.3rem 0.6rem;
        border-radius: 4px;
        font-size: 0.75rem;
        pointer-events: none;
        transition: all 0.2s ease;
        white-space: nowrap;
      }

      .share-tooltip.visible {
        opacity: 1;
      }

      /* Mobile TOC */
      .inline-toc {
        margin-bottom: 2rem;
        border: 1px solid var(--border-subtle);
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.05);
      }

      .inline-toc details {
        padding: 1rem;
      }

      .inline-toc summary {
        cursor: pointer;
        font-weight: 600;
        color: var(--fg-primary);
        list-style: none;
      }

      .toc-list-mobile {
        list-style: none;
        padding: 1rem 0 0 0;
        margin: 0;
      }

      /* Typography Updates */
      .prose {
        font-size: 1rem; /* Reduced from 1.1rem */
        line-height: 1.75;
        color: var(--fg-primary);
        width: 100%;
      }

      /* Prose Specific Overrides */
      .prose h2 {
        font-size: 1.8rem;
        margin-top: 3rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--border-subtle);
        color: var(--fg-primary);
        scroll-margin-top: 100px; /* For sticky header */
      }

      .prose h3 {
        font-size: 1.4rem;
        margin-top: 2rem;
        color: var(--fg-primary);
        scroll-margin-top: 100px;
      }

      .prose ul, .prose ol {
        margin-bottom: 1.5rem;
        padding-left: 1.5rem;
        color: var(--fg-secondary);
      }

      .prose li {
        margin-bottom: 0.5rem;
      }

      .prose strong {
        color: var(--fg-primary);
        font-weight: 600;
      }

      /* Code Blocks */
      :global(.prose pre) {
        width: 100%;
        max-width: 100%;
        margin: 2rem 0;
        border-radius: 8px;
        overflow-x: auto;
      }

      .post-footer {
        margin-top: 5rem;
        text-align: center;
        padding-top: 3rem;
        border-top: 1px solid var(--border-subtle);
        width: 100%;
        max-width: 800px;
        margin-left: auto;
        margin-right: auto;
      }

      .back-link {
        display: inline-block;
        padding: 0.8rem 1.5rem;
        border: 1px solid var(--border-subtle);
        border-radius: 8px;
        color: var(--fg-secondary);
        font-weight: 500;
        font-size: 1rem;
        transition: all 0.2s ease;
        background: rgba(255, 255, 255, 0.05);
      }

      .back-link:hover {
        border-color: var(--fg-muted);
        color: var(--fg-primary);
        transform: translateY(-2px);
      }

      /* Responsive Display */
      .desktop-only {
        display: block;
      }

      .mobile-only {
        display: none;
      }

      @media (max-width: 1200px) {
        .content-grid {
          grid-template-columns: 1fr;
          max-width: 100%;
          padding: 0 1rem;
          gap: 0;
        }

        .sidebar-left, .sidebar-right {
          display: none;
        }

        .desktop-only {
          display: none;
        }

        .mobile-only {
          display: block;
        }

        .prose-container {
          max-width: 100%;
        }

        .prose {
          font-size: 1rem;
          padding: 0;
        }

        .post-footer {
          max-width: 100%;
        }
      }

      @media (max-width: 768px) {
        .post-title {
          font-size: 2rem;
          line-height: 1.2;
        }

        .prose {
          font-size: 0.95rem;
        }

        .hero-image-container {
          margin-left: -1rem;
          margin-right: -1rem;
          border-radius: 0;
        }

        .post-header {
          padding: 0 0.5rem;
        }
      }
    </style>
  </body>
</html>
