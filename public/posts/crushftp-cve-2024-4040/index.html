<!DOCTYPE html>
<html class="no-js" lang="en">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>CVE 2024-4040 - CrushFTP Server-Side Template Injection Vulnerability Analysis - </title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo logo--mixed">
		<a class="logo__link" href="/" title="PwnFuzz" rel="home">
			<div class="logo__item logo__imagebox">
					<img class="logo__img" src="/img/pwnfuzz.png">
				</div><div class="logo__item logo__text">
					<div class="logo__title">PwnFuzz</div>
					<div class="logo__tagline">Fuzz. Pwn. Repeat.</div>
				</div>
		</a>
	</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/">
				
				<span class="menu__text">Home</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/about/">
				
				<span class="menu__text">About</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/tags/">
				
				<span class="menu__text">Tags</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>

		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">CVE 2024-4040 - CrushFTP Server-Side Template Injection Vulnerability Analysis</h1>
			
		</header>
		<div class="content post__content clearfix">
			<p>This blog post contains a thorough analysis of Server Side Template Injection vulnerability in a commercial Managed File Transfer product named CrushFTP. Exploit script is available <a href="https://github.com/D4mianWayne/POCs/tree/main/CVE%202024-4040">here</a>.</p>
<h1 id="cve-2024-4040---crushftp-server-side-template-injection-vulnerability">CVE 2024-4040 - CrushFTP Server-Side Template Injection Vulnerability</h1>
<hr>
<p>I am writing a blog post after a very long time. Finally the “hiatus” has ended and now I am back on track for analyzing real world vulnerabilities and how it has been exploited, more so I will try to uncover what exactly happens under the hood. For starter, I had many vulnerabilities listed and I was confused on what to pick up first but then I saw a news stating that a zero day vulnerability was identified in CrushFTP server. I worked on FTP server sometimes back as part of my work so I thought this would be better to pick for starter.</p>
<p>Before we delve into the vulnerability and exploit, at the time of writing this blog, there are numerous other articles, exploits and scanning script available on the Internet. I have used them for reference at times to understand which part of the server was actually vulnerable.</p>
<blockquote>
<p><a href="https://www.crushftp.com/crush11wiki/Wiki.jsp?page=Update">Source</a>:
<strong>April 19th, 2024</strong> - CVE-2024-4040 CrushFTP v11 versions below 11.1 have a vulnerability where users can  escape their VFS and download system files.  This has been patched in v11.1.0.  Customers using a <a href="https://www.crushftp.com/crush11wiki/Wiki.jsp?page=DMZ">DMZ</a> in front of their main CrushFTP instance are partially protected with its protocol translation system it utilizes.  A DMZ however does not fully protect you and you must update immediately.  (CREDIT:Simon Garrelou, of Airbus CERT)</p></blockquote>
<p>Given that the all versions below 11.1.0 and specific version of 10.x is vulnerable to SSTI vulnerability, it could really help us if we can get an older version of this. In this case, there was <code>shokinn/crushftp:latest</code> docker image was present which can spin up a local CrushFTP server with 30 days of trial, more than enough for us to walk through such vulnerability.</p>
<p>Once the docker is up and running, we can login to the CrushFTP and confirm the version is 9.3.1_9</p>
<p><img src="/img/CrushFTP/Untitled.png" alt="Untitled"></p>
<p>From the publicly available data, I found that the vulnerability that allow reading of local files can be triggered by navigating to following URL:</p>

<p>If we break this URL down, we see that on the <code>/WebInterface/function</code> endpoint it gives <code>command</code> parameter with a value of <code>zip</code> followed by <code>c2f</code> which will contain <code>currentAuth</code> value from the cookie and a <code>path</code> parameter where the payload is given. As we already know that this is an unauthenticated vulnerability, this endpoint seemingly don’t require any kind of authentication. More so, it seems like an API call being made for performing a zip operation on the defined path. To further look into this, I checked the <code>ServerSessionAJAX.class</code> file:</p>

<p>As we see here, this part of code ends up checking if we have the proper permission to zip the requested file path and we won’t be having it, in this particular case, so what will happen is the following piece of code will be taken place:</p>

<p>Something to notice here is that our parameter value of <code>path</code> is being included in the response as well and then it is passed to the <code>this.WriteResponse</code> , if we look closely into the <code>WriteResponse</code> functions, a method overloading approach has been done to this such that this function will be called in accordance to the parameters passed to it.</p>

<p>In the preceding code, it was noted that only the <code>response</code> argument was passed to the <code>writeResponse</code> method. However, upon closer inspection, it becomes evident that the primary <code>writeResponse</code> method requires an additional boolean argument called <code>convertVars</code> as its third parameter. The first <code>writeResponse</code> call sets this argument to <code>true</code>, indicating that variable conversion (<code>convertVars</code>) is enabled. Consequently, the method <code>ServerStatus.thisObj.change_vars_to_values</code> will be invoked.</p>
<hr>
<h2 id="custom-templating-engine">Custom Templating Engine</h2>
<p>As noticed before, the <code>change_vars_to_values</code> method is called as a method from the <code>ServerStatus</code> class.</p>
<p><img src="/img/CrushFTP/Untitled_1.png" alt="Untitled"></p>
<p>The main chunk of code is rather big but not complicated to understand. Looking closely into the <code>change_vars_to_values</code>:</p>

<p>The <code>change_vars_to_values</code> function calls <code>change_vars_to_values_static</code> , this function works like a template engine where it takes placeholder variable and substitute for it’s real value. It first parses the given placeholder value and then substitute it’s value by performing some <em>specified</em> operation.</p>
<ul>
<li>By specified, I meant that the application has defined methods and classes to substitute specific keywords. For the file read vulnerability, there is one such method as well, we will be gooing</li>
</ul>
<p>For example, the following code will replace the placeholders with specified values by retrieving from configurations:</p>

<p>If the given placeholder is something like <code>{{ user_name }}</code> , it will give the current user’s name which in this case will be <code>anonymous</code> as we will make the connection as a guest. This is a typical behavior of a template rendering as we commonly see in Jinja (Python’s flask) or Razor (.NET) templates.</p>
<p><img src="/img/CrushFTP/Untitled_2.png" alt="Untitled"></p>
<p>As  we can see, the given <code>user_name</code> has been replaced with current user’s name.</p>
<p>There are certain values which are being processed differently:</p>
<p><img src="/img/CrushFTP/Untitled_3.png" alt="Untitled"></p>
<p>Two things that seems to be of interesting from exploitation point of view are <code>&lt;LIST&gt;</code> and <code>&lt;INCLUDE&gt;</code> and we see if such placeholders are passed to the <code>change_vars_to_values_static</code> method, it ends up calling <code>get_dir_list</code> and <code>do_include_file_command</code> respectively. Calling <code>get_dir_list</code> resulted in a failure:</p>
<p><img src="/img/CrushFTP/Untitled_4.png" alt="Untitled"></p>
<p>The reason is rather clear why this happens, checking the method <code>get_dir_list</code> , we see that it only lists the files/folders from the user’s VFS (Virtual File Share) given that the anonymous user will not have any VFS configured for it, it does make sense why it failed simply:</p>

<h3 id="arbitrary-file-read-vulnerability-via-ssti">Arbitrary File Read Vulnerability via SSTI</h3>
<p>Now, moving on to the <code>do_include_file_command</code> , let’s analyze the method:</p>

<p>Recalling that the disclosure for this vulnerability mentioned that VFS sandbox bypass meaning an attacker will be able to request any file on the system not just from the VFS. This is what made the vulnerability a rather severity one. In the above code snippet, we don’t see any explicit check against the given directory to be within the VFS like we saw in the <code>get_dir_list</code> , to give an overview, this method parses the given placeholder value, for example if <code>&lt;INCLUDE&gt;/etc/passwd&lt;/INCLUDE&gt;</code> , it will get the <code>/etc/passwd</code> and store it in the <code>file_name</code> and then using the <code>[includer.read](http://includer.read)</code>  method, it will read that file and then return the retrieved content.</p>
<p>Let’s test this out by reading the <code>/etc/passwd</code> file:</p>

<p><img src="/img/CrushFTP/Untitled_5.png" alt="Untitled"></p>
<p>Retrieving the contents of <code>/etc/passwd</code> using the <code>INCLUDE</code> template.</p>
<p>This is the vulnerability which was mainly discussed everywhere but rather what happened here is the custom templating engine that CrushFTP has implemented and the <code>INCLUDE</code> which is a specified template for retrieving specific file. Since the direct call of this function does not check for files within the VFS allowing us to traverse through the whole file system.</p>
<h4 id="authentication-bypass-via-sessionsobj">Authentication Bypass via <code>sessions.obj</code></h4>
<p>Using this Arbitrary File read vulnerability, we can get the session cookies for the users by reading the <code>sessions.obj</code> , this file contains raw data and also stores session cookies for the logged in users. Once retrieved, one can extract the session cookies and then use it to access the CrushFTP functionalities.
<img src="/img/CrushFTP/sessions_obj.png" alt="Untitled"></p>
<hr>
<h2 id="leveraging-to-rce">Leveraging to RCE</h2>
<p>There was also a vague mention of how this vulnerability can open certain avenues to perform RCE. I walked through the application from the admin session to find if there is any specific functionalities which may let us achieve code execution. One of such functionalities was</p>
<p>Preferences → Plugins → CrushSQL</p>
<p><img src="/img/CrushFTP/Untitled_6.png" alt="Untitled"></p>
<p>I tried to compile a jar file by having a <code>Main.class</code> file in it with the <code>Driver</code> as the public class name but it returned following error:</p>
<blockquote>
<p><code>java.lang.ClassCastException</code>: class Main cannot be cast to class <code>java.sql.Driver</code> (Main is in unnamed module of loader <code>java.net.URLClassLoader @62f16978; java.sql.Driver</code> is in module <code>java.sql</code> of loader &lsquo;platform&rsquo;)</p></blockquote>
<p><img src="/img/CrushFTP/Untitled_7.png" alt="Untitled"></p>
<p>The error occurs because the class <code>Driver</code> is being incorrectly cast to the interface <code>java.sql.Driver</code>, suggesting an attempt to use <code>Driver</code> as a JDBC driver, which it is not, leading to a <code>ClassCastException</code>.</p>
<p>So in order to keep things simple, I downloaded the <a href="https://repo1.maven.org/maven2/mysql/mysql-connector-java/5.0.4/mysql-connector-java-5.0.4.jar">mysqlconnector jar</a> file and then decompressed the jar file and then changed the <code>Driver.class</code> by adding my own code and then recompiled the <code>.java</code> file to <code>class</code></p>

<p>Once done, it is time to pack it back to jar again</p>

<p>Once the jar is ready, we can now go back to the CrushSQL and configure the Database Driver file and save the settings. Once we clicked on “Test settings”, it will hang up for a second and throw the shown error but the command will be executed:</p>
<p><img src="/img/CrushFTP/Untitled_8.png" alt="Untitled"></p>
<p>We can see that the file has been created:</p>

<p>I have made my own script which triggers the vulnerability and checks if the target CrushFTP is vulnerable or not and if it is, it will retrieve the specified file.</p>
<blockquote>
<p>Unfortunately, automating the RCE is not worth the effort in this case as it is multi-step process. Not that it cannot be automated with extra effort, it is just some dependency on the VFS share where you have uploaded the jar file have to be specified during the plugin configuration. It will not be scalable per se.</p></blockquote>

<p><img src="/img/CrushFTP/Untitled_9.png" alt="Untitled"></p>
<p>The exploit script and the exploit.jar (used for RCE) can be found <a href="https://github.com/D4mianWayne/POCs/tree/main/CVE%202024-4040">here</a>.</p>
<h2 id="patch">Patch</h2>
<p>The CrushFTP developers fixed this in 11.1.0 and 10.6.0 versions. Checking the <code>writeResponse</code> method, we clearly see that the function which was previously being called has been changed, it is now renamed to <code>change_user_safe_vars_to_values_static</code>  , previously it was <code>change_vars_to_values</code></p>

<p>And checking the <code>change_user_safe_vars_to_values_static</code> , we see that there are two new lines added to the start of this function:</p>

<p>We can see that it checks the given string if it contains either of following characters:</p>

<p>More so, this function does not even check for <code>INCLUDE</code> or any other such tags for that matter basically mitigating any chances of invoking those.</p>

<h3 id="references">References:</h3>
<ul>
<li><a href="https://nvd.nist.gov/vuln/detail/CVE-2024-4040">https://nvd.nist.gov/vuln/detail/CVE-2024-4040</a></li>
<li><a href="https://attackerkb.com/topics/20oYjlmfXa/cve-2024-4040/rapid7-analysis">https://attackerkb.com/topics/20oYjlmfXa/cve-2024-4040/rapid7-analysis</a></li>
<li><a href="https://github.com/airbus-cert/CVE-2024-4040">https://github.com/airbus-cert/CVE-2024-4040</a></li>
<li><a href="https://www.crushftp.com/crush10wiki/Wiki.jsp?page=Update">https://www.crushftp.com/crush10wiki/Wiki.jsp?page=Update</a></li>
<li><a href="https://www.rapid7.com/blog/post/2024/04/23/etr-unauthenticated-crushftp-zero-day-enables-complete-server-compromise/">https://www.rapid7.com/blog/post/2024/04/23/etr-unauthenticated-crushftp-zero-day-enables-complete-server-compromise/</a></li>
<li><a href="https://www.bleepingcomputer.com/news/security/crushftp-warns-users-to-patch-exploited-zero-day-immediately/">https://www.bleepingcomputer.com/news/security/crushftp-warns-users-to-patch-exploited-zero-day-immediately/</a></li>
</ul>

		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M4 0h8s2 0 4 2l15 15s2 2 0 4L21 31s-2 2-4 0L2 16s-2-2-2-4V3s0-3 4-3m3 10a3 3 0 0 0 0-6 3 3 0 0 0 0 6"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/cve-2024-4040/" rel="tag">cve-2024-4040</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/java/" rel="tag">Java</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/ssti/" rel="tag">SSTI</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/rce/" rel="tag">RCE</a>
		</li>
	</ul>
</div>
		</footer>
	</article>
</main>




			</div>
			<aside class="sidebar"><div class="widget-search widget">
	<form class="widget-search__form" role="search" method="get" action="https://google.com/search">
		<input class="widget-search__field" type="search" placeholder="Search…" value="" name="q" aria-label="Search…">
		<input class="widget-search__submit" type="submit" value="Search">
		<input type="hidden" name="sitesearch" value="http://localhost:1313/">
	</form>
</div>
<div class="widget-recent widget">
	<h4 class="widget__title">Recent Posts</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item"><a class="widget__link" href="/posts/crushftp-cve-2025-2825/">CVE 2025-2825 - CrushFTP Authentication Bypass Analysis</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/hpe-irs-cve-deep-dive/">Exploring Recent CVEs in HPE Insight Remote Support</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/ivanti-endpoint-manager-xxe-cve-2024-37397/">CVE 2024-37397 - Ivanti Endpoint Manager XXE Vulnerability</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/crushftp-cve-2024-4040/">CVE 2024-4040 - CrushFTP Server-Side Template Injection Vulnerability Analysis</a></li>
		</ul>
	</div>
</div>
<div class="widget-categories widget">
	<h4 class="widget__title">Categories</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item">
				<a class="widget__link" href="/categories/cve-analysis/">CVE Analysis</a></li>
		</ul>
	</div>
</div>
<div class="widget-taglist widget">
	<h4 class="widget__title">Tags</h4>
	<div class="widget__content">
		<a class="widget-taglist__link widget__link btn" href="/tags/java/" title="Java">Java (3)</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/rce/" title="RCE">RCE (2)</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/xxe/" title="XXE">XXE (2)</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/.net/" title=".NET">.NET (1)</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/auth-bypass/" title="Auth-Bypass">Auth-Bypass (1)</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/cve-2024-37297/" title="CVE-2024-37297">CVE-2024-37297 (1)</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/cve-2024-4040/" title="Cve-2024-4040">Cve-2024-4040 (1)</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/cve-2024-53675/" title="CVE-2024-53675">CVE-2024-53675 (1)</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/cve-2024-53676/" title="CVE-2024-53676">CVE-2024-53676 (1)</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/cve-2025-2825/" title="CVE-2025-2825">CVE-2025-2825 (1)</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/logic-flaw/" title="Logic-Flaw">Logic-Flaw (1)</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/oob-xxe/" title="OOB-XXE">OOB-XXE (1)</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/path-traversal/" title="Path Traversal">Path Traversal (1)</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/ssti/" title="SSTI">SSTI (1)</a>
	</div>
</div>

</aside>
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2025 .
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>